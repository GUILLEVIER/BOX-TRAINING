<div class="main-container">
  <!-- Page Header Component -->
  <app-page-header
    title="Crear Nuevo Plan"
    titleIcon="add_circle"
    [showBackButton]="true"
    backTooltip="Volver"
  >
  </app-page-header>

  <!-- Formulario -->
  <form [formGroup]="planForm" (ngSubmit)="onSubmit()">
    <mat-stepper [linear]="true" #stepper>
      <!-- Paso 1: Información Básica -->
      <mat-step [stepControl]="basicInfoGroup" label="Información Básica">
        <div formGroupName="basicInfo">
          <mat-card>
            <mat-card-header>
              <mat-card-title>
                <mat-icon>info</mat-icon>
                Información del Plan
              </mat-card-title>
              <mat-card-subtitle> Datos básicos del plan de entrenamiento </mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
              <app-form-row [fullWidth]="true">
                <mat-form-field appearance="outline">
                  <mat-label>Nombre del Plan</mat-label>
                  <input
                    matInput
                    formControlName="name"
                    placeholder="Ej: Plan CrossFit Avanzado"
                    maxlength="100"
                  />
                  <mat-hint>Nombre descriptivo y único para el plan</mat-hint>
                  @if (basicInfoGroup.get('name')?.hasError('required') &&
                  basicInfoGroup.get('name')?.touched) {
                  <mat-error>El nombre es obligatorio</mat-error>
                  } @if (basicInfoGroup.get('name')?.hasError('minlength')) {
                  <mat-error>El nombre debe tener al menos 3 caracteres</mat-error>
                  } @if (basicInfoGroup.get('name')?.hasError('maxlength')) {
                  <mat-error>El nombre no puede superar los 100 caracteres</mat-error>
                  }
                </mat-form-field>
              </app-form-row>
              <app-form-row [fullWidth]="true">
                <mat-form-field appearance="outline">
                  <mat-label>Tipo de Plan</mat-label>
                  <mat-select formControlName="type">
                    @for (planType of planTypes; track planType.value) {
                    <mat-option [value]="planType.value">
                      <div>
                        <div>
                          <div>{{ planType.label }}</div>
                          <div>{{ planType.description }}</div>
                        </div>
                      </div>
                    </mat-option>
                    }
                  </mat-select>
                  <mat-hint>Seleccione el tipo de entrenamiento</mat-hint>
                  @if (basicInfoGroup.get('type')?.hasError('required') &&
                  basicInfoGroup.get('type')?.touched) {
                  <mat-error>El tipo de plan es obligatorio</mat-error>
                  }
                </mat-form-field>
              </app-form-row>
              <app-form-row [fullWidth]="true">
                <mat-form-field appearance="outline">
                  <mat-label>Descripción</mat-label>
                  <textarea
                    matInput
                    formControlName="description"
                    placeholder="Describe las características y beneficios del plan"
                    rows="4"
                    maxlength="500"
                  >
                  </textarea>
                  <mat-hint>Descripción detallada del plan (máximo 500 caracteres)</mat-hint>
                  @if (basicInfoGroup.get('description')?.hasError('required') &&
                  basicInfoGroup.get('description')?.touched) {
                  <mat-error>La descripción es obligatoria</mat-error>
                  } @if (basicInfoGroup.get('description')?.hasError('minlength')) {
                  <mat-error>La descripción debe tener al menos 10 caracteres</mat-error>
                  }
                </mat-form-field>
              </app-form-row>
            </mat-card-content>
            <mat-card-actions align="end">
              <button mat-raised-button color="primary" matStepperNext>
                Siguiente
                <mat-icon>navigate_next</mat-icon>
              </button>
            </mat-card-actions>
          </mat-card>
        </div>
      </mat-step>
      <!-- Paso 2: Configuración -->
      <mat-step [stepControl]="configGroup" label="Configuración">
        <div formGroupName="config">
          <mat-card>
            <mat-card-header>
              <mat-card-title>
                <mat-icon>settings</mat-icon>
                Configuración del Plan
              </mat-card-title>
              <mat-card-subtitle> Define duración, clases y precio </mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
              <app-form-row>
                <mat-form-field appearance="outline">
                  <mat-label>Duración (días)</mat-label>
                  <input
                    matInput
                    type="number"
                    formControlName="durationDays"
                    min="1"
                    max="365"
                    placeholder="30"
                  />
                  <mat-hint>Duración del plan en días</mat-hint>
                  @if (configGroup.get('durationDays')?.hasError('required') &&
                  configGroup.get('durationDays')?.touched) {
                  <mat-error>La duración es obligatoria</mat-error>
                  } @if (configGroup.get('durationDays')?.hasError('min')) {
                  <mat-error>La duración debe ser al menos 1 día</mat-error>
                  } @if (configGroup.get('durationDays')?.hasError('max')) {
                  <mat-error>La duración no puede superar 365 días</mat-error>
                  }
                </mat-form-field>
                <mat-form-field appearance="outline">
                  <mat-label>Clases Incluidas</mat-label>
                  <input
                    matInput
                    type="number"
                    formControlName="includedClasses"
                    min="1"
                    max="999"
                    placeholder="12"
                  />
                  <mat-hint>Número máximo de clases (999 = ilimitadas)</mat-hint>
                  @if (configGroup.get('includedClasses')?.hasError('required') &&
                  configGroup.get('includedClasses')?.touched) {
                  <mat-error>El número de clases es obligatorio</mat-error>
                  } @if (configGroup.get('includedClasses')?.hasError('min')) {
                  <mat-error>Debe incluir al menos 1 clase</mat-error>
                  }
                </mat-form-field>
              </app-form-row>
              <app-form-row [fullWidth]="true">
                <mat-form-field appearance="outline">
                  <mat-label>Precio ($)</mat-label>
                  <input
                    matInput
                    type="number"
                    formControlName="price"
                    min="0"
                    step="1000"
                    placeholder="50000"
                  />
                  <mat-icon matPrefix>attach_money</mat-icon>
                  <mat-hint>Precio del plan en pesos chilenos</mat-hint>
                  @if (configGroup.get('price')?.hasError('required') &&
                  configGroup.get('price')?.touched) {
                  <mat-error>El precio es obligatorio</mat-error>
                  } @if (configGroup.get('price')?.hasError('min')) {
                  <mat-error>El precio debe ser mayor o igual a 0</mat-error>
                  }
                </mat-form-field>
              </app-form-row>
              <!-- Vista previa de configuración -->
              @if (configPreview()) {
              <div>
                <h4>Vista Previa</h4>
                <div>
                  <mat-icon>schedule</mat-icon>
                  <span>{{ getDurationText() }}</span>
                </div>
                <div>
                  <mat-icon>fitness_center</mat-icon>
                  <span>{{ getClassesText() }}</span>
                </div>
                <div>
                  <mat-icon>monetization_on</mat-icon>
                  <span>{{ formatCurrency(configGroup.get('price')?.value) }}</span>
                </div>
              </div>
              }
            </mat-card-content>
            <mat-card-actions align="end">
              <button mat-button matStepperPrevious>
                <mat-icon>navigate_before</mat-icon>
                Anterior
              </button>
              <button mat-raised-button color="primary" matStepperNext>
                Siguiente
                <mat-icon>navigate_next</mat-icon>
              </button>
            </mat-card-actions>
          </mat-card>
        </div>
      </mat-step>
      <!-- Paso 4: Confirmación -->
      <mat-step label="Confirmación">
        <mat-card>
          <mat-card-header>
            <mat-card-title>
              <mat-icon>check_circle</mat-icon>
              Revisar y Confirmar
            </mat-card-title>
            <mat-card-subtitle> Revisa la información antes de crear el plan </mat-card-subtitle>
          </mat-card-header>
          <mat-card-content>
            <div>
              <h4>Información Básica</h4>
              <div>
                <span>Nombre:</span>
                <span>{{ basicInfoGroup.get('name')?.value }}</span>
              </div>
              <div>
                <span>Tipo:</span>
                <span>{{ getPlanTypeLabel(basicInfoGroup.get('type')?.value) }}</span>
              </div>
              <div>
                <span>Descripción:</span>
                <span>{{ basicInfoGroup.get('description')?.value }}</span>
              </div>
            </div>
            <div>
              <h4>Configuración</h4>
              <div>
                <span>Duración:</span>
                <span>{{ getDurationText() }}</span>
              </div>
              <div>
                <span>Clases Incluidas:</span>
                <span>{{ getClassesText() }}</span>
              </div>
              <div>
                <span>Precio:</span>
                <span>{{ formatCurrency(configGroup.get('price')?.value) }}</span>
              </div>
            </div>
          </mat-card-content>
          <mat-card-actions align="end">
            <button mat-button matStepperPrevious>
              <mat-icon>navigate_before</mat-icon>
              Anterior
            </button>
            <button
              mat-raised-button
              color="primary"
              type="submit"
              [disabled]="planForm.invalid || creating()"
            >
              @if (creating()) {
              <ng-container>
                <mat-icon>hourglass_empty</mat-icon>
                Creando...
              </ng-container>
              } @else {
              <ng-container>
                <mat-icon>add</mat-icon>
                Crear Plan
              </ng-container>
              }
            </button>
          </mat-card-actions>
        </mat-card>
      </mat-step>
    </mat-stepper>
  </form>
  <!-- Indicador de progreso -->
  @if (creating()) {
  <mat-progress-bar mode="indeterminate"></mat-progress-bar>
  }
</div>
