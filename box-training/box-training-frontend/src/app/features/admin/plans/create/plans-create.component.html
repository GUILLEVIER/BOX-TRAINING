<div class="main-container">
  <!-- Page Header Component -->
  <app-page-header
    title="Crear Nuevo Plan"
    titleIcon="add_circle"
    [showBackButton]="true"
    backTooltip="Volver"
  >
  </app-page-header>

  <!-- Formulario -->
  <form [formGroup]="planForm" (ngSubmit)="onSubmit()">
    <mat-stepper [linear]="true" #stepper>
      <!-- Paso 1: Información Básica -->
      <mat-step [stepControl]="basicInfoGroup" label="Información Básica">
        <div formGroupName="basicInfo">
          <mat-card>
            <mat-card-header>
              <mat-card-title>
                <mat-icon>info</mat-icon>
                Información del Plan
              </mat-card-title>
              <mat-card-subtitle> Datos básicos del plan de entrenamiento </mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
              <app-form-row [fullWidth]="true">
                <mat-form-field appearance="outline">
                  <mat-label>Nombre del Plan</mat-label>
                  <input
                    matInput
                    formControlName="name"
                    placeholder="Ej: Plan CrossFit Avanzado"
                    maxlength="100"
                  />
                  <mat-hint>Nombre descriptivo y único para el plan</mat-hint>
                  @if (basicInfoGroup.get('name')?.hasError('required') &&
                  basicInfoGroup.get('name')?.touched) {
                  <mat-error>El nombre es obligatorio</mat-error>
                  } @if (basicInfoGroup.get('name')?.hasError('minlength')) {
                  <mat-error>El nombre debe tener al menos 3 caracteres</mat-error>
                  } @if (basicInfoGroup.get('name')?.hasError('maxlength')) {
                  <mat-error>El nombre no puede superar los 100 caracteres</mat-error>
                  } @if (basicInfoGroup.get('name')?.hasError('uniqueName')) {
                  <mat-error>{{ basicInfoGroup.get('name')?.errors?.['uniqueName']?.message }}</mat-error>
                  }
                </mat-form-field>
              </app-form-row>
              <app-form-row [fullWidth]="true">
                <mat-form-field appearance="outline">
                  <mat-label>Tipo de Plan</mat-label>
                  <mat-select formControlName="type" multiple>
                    @for (planType of planTypes; track planType.value.id) {
                    <mat-option [value]="planType.value">
                      <div class="plan-type-option">
                        <div class="plan-type-header">
                          <mat-icon>{{ planType.icon }}</mat-icon>
                          <span class="plan-type-label">{{ planType.label }}</span>
                          <mat-chip class="format-chip" [class.online]="planType.value.format === 'ONLINE'">
                            {{ planType.value.format }}
                          </mat-chip>
                        </div>
                        <div class="plan-type-description">{{ planType.description }}</div>
                      </div>
                    </mat-option>
                    }
                  </mat-select>
                  <mat-hint>Seleccione uno o más tipos de entrenamiento</mat-hint>
                  @if (basicInfoGroup.get('type')?.hasError('required') &&
                  basicInfoGroup.get('type')?.touched) {
                  <mat-error>Debe seleccionar al menos un tipo de plan</mat-error>
                  }
                </mat-form-field>
              </app-form-row>
              <app-form-row [fullWidth]="true">
                <mat-form-field appearance="outline">
                  <mat-label>Descripción</mat-label>
                  <textarea
                    matInput
                    formControlName="description"
                    placeholder="Describe las características y beneficios del plan"
                    rows="4"
                    maxlength="500"
                  >
                  </textarea>
                  <mat-hint>Descripción detallada del plan (máximo 500 caracteres)</mat-hint>
                  @if (basicInfoGroup.get('description')?.hasError('required') &&
                  basicInfoGroup.get('description')?.touched) {
                  <mat-error>La descripción es obligatoria</mat-error>
                  } @if (basicInfoGroup.get('description')?.hasError('minlength')) {
                  <mat-error>La descripción debe tener al menos 10 caracteres</mat-error>
                  }
                </mat-form-field>
              </app-form-row>
              
              <!-- Imagen del Plan -->
              <app-form-row [fullWidth]="true">
                <div class="image-upload-section">
                  <h4>
                    <mat-icon>image</mat-icon>
                    Imagen Característica del Plan
                  </h4>
                  <div class="upload-area" 
                       [class.has-image]="selectedImage()"
                       (click)="imageInput.click()">
                    @if (selectedImage()) {
                      <div class="image-preview">
                        <img [src]="selectedImage()" alt="Vista previa de la imagen del plan">
                        <div class="image-overlay">
                          <mat-icon>edit</mat-icon>
                          <span>Cambiar imagen</span>
                        </div>
                      </div>
                    } @else {
                      <div class="upload-placeholder">
                        <mat-icon>cloud_upload</mat-icon>
                        <span>Subir imagen del plan</span>
                        <small>Formatos: JPG, PNG, WEBP (máx. 5MB)</small>
                      </div>
                    }
                  </div>
                  <input #imageInput
                         type="file"
                         accept="image/*"
                         (change)="onImageSelected($event)"
                         style="display: none;">
                  @if (selectedImage()) {
                    <button mat-stroked-button color="warn" 
                            type="button"
                            (click)="removeImage()">
                      <mat-icon>delete</mat-icon>
                      Eliminar imagen
                    </button>
                  }
                </div>
              </app-form-row>
            </mat-card-content>
            <mat-card-actions align="end">
              <button mat-raised-button color="primary" matStepperNext>
                Siguiente
                <mat-icon>navigate_next</mat-icon>
              </button>
            </mat-card-actions>
          </mat-card>
        </div>
      </mat-step>
      <!-- Paso 2: Configuración -->
      <mat-step [stepControl]="configGroup" label="Configuración">
        <div formGroupName="config">
          <mat-card>
            <mat-card-header>
              <mat-card-title>
                <mat-icon>settings</mat-icon>
                Configuración del Plan
              </mat-card-title>
              <mat-card-subtitle> Define duración, clases y precio </mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
              <app-form-row>
                <mat-form-field appearance="outline">
                  <mat-label>Duración (días)</mat-label>
                  <input
                    matInput
                    type="number"
                    formControlName="durationDays"
                    min="1"
                    max="365"
                    placeholder="30"
                  />
                  <mat-hint>Duración del plan en días</mat-hint>
                  @if (configGroup.get('durationDays')?.hasError('required') &&
                  configGroup.get('durationDays')?.touched) {
                  <mat-error>La duración es obligatoria</mat-error>
                  } @if (configGroup.get('durationDays')?.hasError('min')) {
                  <mat-error>La duración debe ser al menos 1 día</mat-error>
                  } @if (configGroup.get('durationDays')?.hasError('max')) {
                  <mat-error>La duración no puede superar 365 días</mat-error>
                  }
                </mat-form-field>
                <mat-form-field appearance="outline">
                  <mat-label>Clases Incluidas</mat-label>
                  <input
                    matInput
                    type="number"
                    formControlName="includedClasses"
                    min="1"
                    max="999"
                    placeholder="12"
                  />
                  <mat-hint>Número máximo de clases (999 = ilimitadas)</mat-hint>
                  @if (configGroup.get('includedClasses')?.hasError('required') &&
                  configGroup.get('includedClasses')?.touched) {
                  <mat-error>El número de clases es obligatorio</mat-error>
                  } @if (configGroup.get('includedClasses')?.hasError('min')) {
                  <mat-error>Debe incluir al menos 1 clase</mat-error>
                  }
                </mat-form-field>
              </app-form-row>
              <app-form-row [fullWidth]="true">
                <mat-form-field appearance="outline">
                  <mat-label>Precio ($)</mat-label>
                  <input
                    matInput
                    type="number"
                    formControlName="price"
                    min="0"
                    step="1000"
                    placeholder="50000"
                  />
                  <mat-icon matPrefix>attach_money</mat-icon>
                  <mat-hint>Precio del plan en pesos chilenos</mat-hint>
                  @if (configGroup.get('price')?.hasError('required') &&
                  configGroup.get('price')?.touched) {
                  <mat-error>El precio es obligatorio</mat-error>
                  } @if (configGroup.get('price')?.hasError('min')) {
                  <mat-error>El precio debe ser mayor o igual a 0</mat-error>
                  }
                </mat-form-field>
              </app-form-row>
              <!-- Vista previa de configuración -->
              @if (configPreview()) {
              <div class="config-preview">
                <h4>Vista Previa</h4>
                <div class="preview-item">
                  <mat-icon>schedule</mat-icon>
                  <span>{{ getDurationText() }}</span>
                </div>
                <div class="preview-item">
                  <mat-icon>fitness_center</mat-icon>
                  <span>{{ getClassesText() }}</span>
                </div>
                <div class="preview-item">
                  <mat-icon>monetization_on</mat-icon>
                  <span>{{ formatCurrency(configGroup.get('price')?.value) }}</span>
                </div>
              </div>
              }
            </mat-card-content>
            <mat-card-actions align="end">
              <button mat-button matStepperPrevious>
                <mat-icon>navigate_before</mat-icon>
                Anterior
              </button>
              <button mat-raised-button color="primary" matStepperNext>
                Siguiente
                <mat-icon>navigate_next</mat-icon>
              </button>
            </mat-card-actions>
          </mat-card>
        </div>
      </mat-step>

      <!-- Paso 3: Documentos (solo para planes ONLINE) -->
      @if (hasOnlinePlanType()) {
      <mat-step [stepControl]="documentsGroup" label="Documentos">
        <div formGroupName="documents">
          <mat-card>
            <mat-card-header>
              <mat-card-title>
                <mat-icon>cloud_upload</mat-icon>
                Documentos del Plan Online
              </mat-card-title>
              <mat-card-subtitle>
                Sube los documentos que estarán disponibles para los usuarios
              </mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
              <div class="documents-upload-section">
                <div class="upload-area" (click)="documentsInput.click()">
                  <mat-icon>file_upload</mat-icon>
                  <span>Seleccionar documentos</span>
                  <small>Formatos: PDF, DOC, DOCX, XLS, XLSX (máx. 10MB cada uno)</small>
                </div>
                <input #documentsInput
                       type="file"
                       multiple
                       accept=".pdf,.doc,.docx,.xls,.xlsx"
                       (change)="onDocumentsSelected($event)"
                       style="display: none;">
                
                @if (selectedDocuments().length > 0) {
                  <div class="documents-list">
                    <h4>Documentos seleccionados:</h4>
                    @for (doc of selectedDocuments(); track doc.name) {
                      <div class="document-item">
                        <mat-icon>description</mat-icon>
                        <span class="document-name">{{ doc.name }}</span>
                        <span class="document-size">{{ formatFileSize(doc.size) }}</span>
                        <button mat-icon-button 
                                color="warn"
                                type="button"
                                (click)="removeDocument(doc)"
                                matTooltip="Eliminar documento">
                          <mat-icon>delete</mat-icon>
                        </button>
                      </div>
                    }
                  </div>
                }
              </div>
            </mat-card-content>
            <mat-card-actions align="end">
              <button mat-button matStepperPrevious>
                <mat-icon>navigate_before</mat-icon>
                Anterior
              </button>
              <button mat-raised-button color="primary" matStepperNext>
                Siguiente
                <mat-icon>navigate_next</mat-icon>
              </button>
            </mat-card-actions>
          </mat-card>
        </div>
      </mat-step>
      }
      <!-- Paso 4: Confirmación -->
      <mat-step label="Confirmación">
        <mat-card>
          <mat-card-header>
            <mat-card-title>
              <mat-icon>check_circle</mat-icon>
              Revisar y Confirmar
            </mat-card-title>
            <mat-card-subtitle> Revisa la información antes de crear el plan </mat-card-subtitle>
          </mat-card-header>
          <mat-card-content>
            <div class="confirmation-section">
              <h4>Información Básica</h4>
              <div class="info-grid">
                <div class="info-item">
                  <span class="label">Nombre:</span>
                  <span class="value">{{ basicInfoGroup.get('name')?.value }}</span>
                </div>
                <div class="info-item">
                  <span class="label">Tipos:</span>
                  <div class="plan-types">
                    @for (type of basicInfoGroup.get('type')?.value; track type.id) {
                      <mat-chip class="type-chip">{{ getPlanTypeLabel(type) }}</mat-chip>
                    }
                  </div>
                </div>
                <div class="info-item">
                  <span class="label">Descripción:</span>
                  <span class="value">{{ basicInfoGroup.get('description')?.value }}</span>
                </div>
                @if (selectedImage()) {
                  <div class="info-item">
                    <span class="label">Imagen:</span>
                    <div class="image-thumbnail">
                      <img [src]="selectedImage()" alt="Imagen del plan">
                    </div>
                  </div>
                }
              </div>
            </div>
            
            <div class="confirmation-section">
              <h4>Configuración</h4>
              <div class="info-grid">
                <div class="info-item">
                  <span class="label">Duración:</span>
                  <span class="value">{{ getDurationText() }}</span>
                </div>
                <div class="info-item">
                  <span class="label">Clases Incluidas:</span>
                  <span class="value">{{ getClassesText() }}</span>
                </div>
                <div class="info-item">
                  <span class="label">Precio:</span>
                  <span class="value">{{ formatCurrency(configGroup.get('price')?.value) }}</span>
                </div>
              </div>
            </div>

            @if (hasOnlinePlanType() && selectedDocuments().length > 0) {
              <div class="confirmation-section">
                <h4>Documentos</h4>
                <div class="documents-summary">
                  @for (doc of selectedDocuments(); track doc.name) {
                    <div class="document-summary-item">
                      <mat-icon>description</mat-icon>
                      <span>{{ doc.name }}</span>
                      <small>({{ formatFileSize(doc.size) }})</small>
                    </div>
                  }
                </div>
              </div>
            }
          </mat-card-content>
          <mat-card-actions align="end">
            <button mat-button matStepperPrevious>
              <mat-icon>navigate_before</mat-icon>
              Anterior
            </button>
            <button
              mat-raised-button
              color="primary"
              type="submit"
              [disabled]="planForm.invalid || creating()"
            >
              @if (creating()) {
              <ng-container>
                <mat-icon>hourglass_empty</mat-icon>
                Creando...
              </ng-container>
              } @else {
              <ng-container>
                <mat-icon>add</mat-icon>
                Crear Plan
              </ng-container>
              }
            </button>
          </mat-card-actions>
        </mat-card>
      </mat-step>
    </mat-stepper>
  </form>
  <!-- Indicador de progreso -->
  @if (creating()) {
  <mat-progress-bar mode="indeterminate"></mat-progress-bar>
  }
</div>
